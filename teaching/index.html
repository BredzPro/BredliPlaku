<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Course Materials</title>
    <link rel="icon" type="image/png" href="https://bredliplaku.github.io/favicon.png">
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700&display=swap" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css" rel="stylesheet">
    <!-- Google API client library -->
    <script src="https://apis.google.com/js/api.js" async defer></script>
    <script src="https://accounts.google.com/gsi/client" async defer></script>
<style>
    :root {
        --primary-color: #3949ab;
        --primary-dark: #1a237e;
        --secondary-color: #ffa726;
        --background-color: #f4f4f4;
        --card-background: #ffffff;
        --text-color: #333333;
        --text-light: #ffffff;
        --success-color: #43a047;
        --warning-color: #fb8c00;
        --info-color: #2196F3;
        --danger-color: #f44336;
    }
    
    body, html {
        margin: 0;
        padding: 0;
        font-family: 'Roboto', sans-serif;
        background: #ffffff;
        color: #333;
    }
	
		*, *::before, *::after {
		transition: opacity 0.3s ease, transform 0.3s ease, visibility 0.3s ease;
	}
    
    .container {
        max-width: 1000px;
        margin: 0 auto;
        padding: 20px;
    }
    
    .course-header {
        background: linear-gradient(135deg, #3949ab, #1a237e);
        color: white;
        padding: 30px;
        border-radius: 20px;
        margin-bottom: 10px;
        box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        -webkit-user-select: none;
        -khtml-user-select: none;
    }
    
    h1 {
        margin: 0 0 10px 0;
        font-weight: 700;
        font-size: 2.0em;
    }
    
    h2 {
        margin: 0 0 2px 0;
        font-weight: 400;
        font-size: 1.0em;
    }
    
    .course-info {
        display: flex;
        justify-content: left;
        flex-wrap: wrap;
        margin-top: 15px;
        margin-bottom: 5px;
        gap: 10px;
    }
    
    .info-item {
        background-color: rgba(255,255,255,0.1);
        padding: 10px 15px;
        border-radius: 10px;
        font-size: 0.9em;
    }
    
    .week-counter {
        padding: 10px 0px;
        border-radius: 10px;
        margin: 5px;
        font-size: 0.9em;
        display: inline-block;
    }
    
    .progress-bar {
        background-color: rgb(251, 251, 251);
        height: 10px;
        border-radius: 5px;
        margin: 5px;
        overflow: hidden;
    }
    
    .progress {
        width: 60%;
        height: 100%;
        background-color: #4caf50;
        transition: width 0.5s ease-in-out;
    }
    
    .module {
        background-color: #fff;
        border-radius: 20px;
        box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        margin-bottom: 20px;
        overflow: hidden;
        transition: transform 0.3s ease, box-shadow 0.3s ease;
    }
    
    .module:hover {
        transform: translateY(-2px);
        box-shadow: 0 6px 12px rgba(0,0,0,0.15);
    }
    
    .module-header {
        background-color: #3949ab;
        color: white;
        padding: 15px;
        font-weight: 500;
        display: flex;
        justify-content: space-between;
        align-items: center;
        cursor: pointer;
        -webkit-user-select: none;
        -khtml-user-select: none;
        flex-wrap: wrap;
        position: relative;
    }
    
    .module-title {
        font-size: 1.1em;
    }
    
    .module-chapter {
        margin-left: auto;
        font-size: 0.9em; 
        font-weight: 800;
        display: flex; 
        align-items: center;
        text-transform: uppercase;
    }
    
    .module-content {
        padding: 0;
        max-height: 0;
        overflow: hidden;
        transition: max-height 0.3s ease-out, padding 0.3s ease-out;
    }
    
    .module.active .module-content {
        padding: 15px;
        max-height: 2500px;
        transition: max-height 0.5s ease-in, padding 0.3s ease-in;
    }
    
    .material-item {
        display: flex;
        flex-wrap: wrap;
        align-items: center;
        padding: 5px 15px;
        border-bottom: 1px solid #e0e0e0;
        margin-top: 5px;
    }
    
    .material-item:last-child {
        border-bottom: none;
    }
    
    .material-icon {
        font-size: 1.5em;
        margin-right: 15px;
        color: #3949ab;
    }
    
    .material-info {
        flex-grow: 1;
        margin-bottom: 10px;
    }
    
    .material-title {
        font-weight: 500;
        margin-bottom: 5px;
    }
    
    .material-description {
        font-size: 0.9em;
        color: #666;
        -webkit-user-select: none;
        -khtml-user-select: none;
    }
    
    button {
        display: inline-block;
        background-color: var(--primary-color);
        color: var(--text-light);
        padding: 10px 20px;
        border-radius: 20px;
        text-decoration: none;
        font-size: 0.9em;
        transition: background-color 0.3s, transform 0.3s;
        text-align: center;
        box-shadow: 0 2px 5px rgba(0,0,0,0.2);
        border: 0;
        -webkit-user-select: none;
        -khtml-user-select: none;
        cursor: pointer;
    }
    
    button:hover {
        background-color: #1a237e;
        box-shadow: 0 2px 5px rgba(0,0,0,0.2);
        transform: translateY(-2px);
    }
    
    button:disabled {
        opacity: 0.6;
        cursor: not-allowed;
        transform: none;
    }
    
    .btn-green { background-color: #43a047; }
    .btn-green:hover { background-color: #2e7d32; }
    .btn-orange { background-color: #fb8c00; }
    .btn-orange:hover { background-color: #ef6c00; }
    .btn-blue { background-color: #2196F3; }
    .btn-blue:hover { background-color: #1e87db; }
    .btn-purple { background-color: #9c27b0; }
    .btn-purple:hover { background-color: #7b1fa2; }
    .btn-primary { background-color: var(--primary-color); }
    
    .fun-fact {
        background-color: #FFF9C4;
        border-left: 5px solid #FBC02D;
        padding: 15px;
        margin-top: 20px;
        border-radius: 5px;
        font-style: italic;
    }
    
    .course-actions {
        padding: 5px;
        display: flex;
        justify-content: flex-start;
        flex-wrap: wrap;
        gap: 10px;
    }
    
    .footer {
        max-width: 1000px;
        text-align: center;
        padding: 20px 0;
        color: var(--primary-dark);
        border-radius: 20px;
        margin-left: auto;
        margin-right: auto;
        -webkit-user-select: none;
        -khtml-user-select: none;
    }
    
    .social-links {
        margin-bottom: 10px;
        margin-top: 10px;
    }
    
    .social-links a {
        color: var(--primary-dark);
        font-size: 1.0em;
        margin: 0 10px;
        transition: color 0.3s;
    }
    
    .social-links a:hover {
        color: var(--secondary-color);
    }
    
    /* Course buttons styles from index.html */
    .course-buttons-container {
        padding: 5px;
        display: flex;
        justify-content: flex-start;
        flex-wrap: wrap;
        gap: 10px;
        margin-bottom: 15px;
    }
    
    .course-button {
        background-color: #e0e0e0;
        color: black;
        opacity: 0.7;
        padding: 8px 15px;
        border-radius: 20px;
        font-size: 0.9em;
        text-transform: uppercase;
        cursor: pointer;
        transition: all 0.3s ease;
        -webkit-user-select: none;
        -khtml-user-select: none;
    }
    
    .course-button:hover {
        box-shadow: 0 2px 5px rgba(0,0,0,0.2);
        transform: translateY(-2px);
        cursor: pointer;
    }
    
    .course-button.active {
        background-color: var(--primary-color);
        color: white;
        opacity: 1;
        font-weight: 500;
        box-shadow: 0 2px 5px rgba(0,0,0,0.2);
    }
    
    /* Loading spinner */
    .loading-spinner {
        border: 5px solid rgba(57, 73, 171, 0.2);
        border-top: 5px solid #3949ab;
        border-radius: 50%;
        width: 50px;
        height: 50px;
        animation: spin 1s linear infinite;
        margin: 20px auto;
    }
    
    @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
    }
    
    .loading-text {
        text-align: center;
        color: #666;
        margin-bottom: 20px;
    }
    
    .empty-content {
        text-align: center;
        padding: 30px;
        color: #757575;
        background-color: #f5f5f5;
        border-radius: 10px;
        margin: 20px 0;
    }
    
    /* Notification styles */
    .in-page-notifications {
        position: fixed;
        bottom: 20px;
        right: 20px;
        z-index: 10000;
        width: 350px;
        max-width: 70%;
        pointer-events: none;
    }
    
    .in-page-notification {
        background-color: white;
        border-radius: 8px;
        padding: 15px;
        margin-bottom: 10px;
        box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        animation: slide-in 0.3s ease-out forwards;
        overflow: hidden;
        display: flex;
        align-items: center;
        opacity: 1;
        transition: transform 0.3s ease-in, opacity 0.3s ease-in;
        pointer-events: auto;
    }
    
    .in-page-notification.removing {
        opacity: 0;
        transform: translateX(100%);
    }
    
    @keyframes slide-in {
        from {
            transform: translateX(100%);
            opacity: 0;
        }
        to {
            transform: translateX(0);
            opacity: 1;
        }
    }
    
    .in-page-notification i {
        margin-right: 10px;
        font-size: 1.2em;
    }
    
    .in-page-notification-info {
        background-color: #e3f2fd;
        color: #0d47a1;
    }
    
    .in-page-notification-warning {
        background-color: #fff3e0;
        color: #e65100;
    }
    
    .in-page-notification-error {
        background-color: #ffebee;
        color: #b71c1c;
    }
    
    .in-page-notification-success {
        background-color: #e8f5e9;
        color: #1b5e20;
    }
    
    .notification-close {
        background: none;
        border: none;
        border-radius: 0;
        box-shadow: none;
        cursor: pointer;
        font-size: 18px;
        color: inherit;
        opacity: 0.7;
        padding: 0;
        margin-left: 8px;
        transition: none;
        width: auto;
        height: auto;
        display: inline-block;
        pointer-events: auto;
    }
    
    .notification-close:hover {
        opacity: 1;
        background: none;
        color: inherit;
        box-shadow: none;
    }
    
    /* Main loading screen styles */
    .app-loading {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background-color: #f4f4f4;
        display: flex;
        flex-direction: column;
        justify-content: center;
        align-items: center;
        z-index: 9999;
        transition: opacity 0.5s;
    }
    
    .content-hidden {
        visibility: hidden;
    }
    
    /* Sign in prompt */
    .signin-prompt {
        text-align: center;
        padding: 30px;
        background-color: #f0f4ff;
        border-radius: 10px;
        margin: 20px auto;
        max-width: 500px;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
    }
    
    .signin-prompt i {
        font-size: 2.5em;
        color: var(--primary-color);
        margin-bottom: 15px;
    }
    
    .signin-prompt h3 {
        margin-top: 0;
        color: var(--primary-dark);
    }
    
    .signin-prompt p {
        margin-bottom: 20px;
        color: #555;
    }
    
    .user-info {
        display: flex;
        align-items: center;
        gap: 10px;
        justify-content: center;
        margin-bottom: 15px;
    }
    
    .user-avatar {
        width: 32px;
        height: 32px;
        border-radius: 50%;
    }
    
    @media (max-width: 500px) {
        .module-header {
            flex-direction: column;
            align-items: flex-start;
        }
        .module-title {
            margin-bottom: 8px;
            text-align: left;
        }
        .btn-download {
            display: none;
        }
    }
</style>
</head>
<body>
    <div id="app-loading" class="app-loading">
        <img src="https://raw.githubusercontent.com/bredliplaku/bredliplaku.github.io/refs/heads/main/loading.gif" alt="Loading Cat" style="width: 200px; height: 200px;">
        <div style="margin-top: 10px; font-size: 14px; color: #666;">Meow loading...</div>
    </div>

    <div class="container content-hidden" id="main-container">
        <div class="course-actions">
            <button id="all-courses-btn" style="margin-bottom: 10px;" onclick="window.open('https://teaching.bredliplaku.com/', '_self', 'noopener,noreferrer')">
                <i class="fas fa-chevron-left"></i> All Courses
            </button>
            <button id="eis-btn" style="margin-bottom: 10px;" onclick="window.open('https://eis.epoka.edu.al/', '_blank', 'noopener,noreferrer')" class="btn">
                <i class="far fa-user-circle"></i> EIS
            </button>
            <button id="sign-in-btn" style="margin-bottom: 10px;" onclick="handleAuthClick()" class="btn-blue">
                <i class="fas fa-sign-in-alt"></i> Sign in
            </button>
            <button id="sign-out-btn" style="display: none; margin-bottom: 10px;" onclick="handleSignoutClick()" class="btn-orange">
                <i class="fas fa-sign-out-alt"></i> Sign out
            </button>
        </div>
        
        <div id="user-info-container" style="display: none;" class="user-info">
            <img id="user-avatar" class="user-avatar" src="" alt="User Avatar">
            <span id="user-name"></span>
        </div>
        
        <div class="course-header">
            <h2 id="course-code">Loading course...</h2>
            <h1 id="course-title">Please wait</h1>
            <div class="course-info" id="course-info">
                <span class="info-item"><i class="fas fa-user-circle"></i> Mr. Bredli Plaku</span>
                <span class="info-item"><i class="fas fa-calendar-check"></i> <span id="course-semester">Loading...</span></span>
                <span class="info-item"><i class="fas fa-graduation-cap"></i> <span id="course-level">Loading...</span></span>
                <span class="info-item"><i class="fas fa-exclamation-circle"></i> <span id="course-type">Loading...</span></span>
                <span class="info-item"><i class="fas fa-trophy"></i> <span id="course-credits">Loading...</span></span>
                <span class="info-item"><i class="fas fa-calendar"></i> <span id="course-duration">Loading...</span></span>
            </div>
            <span class="info-item"><i class="far fa-clock fa-spin"></i><div class="week-counter" id="week-counter"></div></span>
            
            <div class="progress-bar">
                <div class="progress" id="progress-bar"></div>
            </div>
        </div>
        
        <div id="course-buttons-container" class="course-buttons-container">
            <!-- Course buttons will be added here dynamically -->
        </div>
        
        <div id="notification-area" class="in-page-notifications"></div>
        
        <div id="signin-container" style="display: none;">
            <div class="signin-prompt">
                <i class="fas fa-lock"></i>
                <h3>Please Sign In</h3>
                <p>Sign in with your EPOKA account to view course materials.</p>
                <button onclick="handleAuthClick()" class="btn-blue">
                    <i class="fas fa-sign-in-alt"></i> Sign in with Google
                </button>
            </div>
        </div>
        
        <div id="course-content">
            <!-- Course content will be loaded here -->
        </div>
    </div>

    <footer class="footer">
        <div class="social-links">
            <a href="https://eis.epoka.edu.al/cv/fullcv/655" target="_blank" rel="noopener noreferrer"><i class="far fa-id-card"></i></a>
            <a href="mailto:bplaku@epoka.edu.al" target="_blank" rel="noopener noreferrer"><i class="far fa-envelope"></i></a>
        </div>
        <p style="font-size:0.7em"><i class="far fa-copyright"></i> 2023-<span id="currentYear"></span> Bredli Plaku. All Rights Reserved.</p>
    </footer>

<script>
// Configuration
const CLIENT_ID = '740588046540-npg0crodtcuinveu6bua9rd6c3hb2s1m.apps.googleusercontent.com';
const API_KEY = 'AIzaSyD295FTtMHvXxZablRf0f-FR-IQ2dQRPQE';
const COURSE_MATERIALS_SPREADSHEET_ID = '1y4uuRPVHvPgqsOXcAeWC2W2S94qp1kgm9oWiXR94W18'; // Replace with your actual spreadsheet ID

// API client configuration
const DISCOVERY_DOCS = ["https://sheets.googleapis.com/$discovery/rest?version=v4"];
const SCOPES = "https://www.googleapis.com/auth/spreadsheets.readonly https://www.googleapis.com/auth/userinfo.email https://www.googleapis.com/auth/userinfo.profile";

// Global variables
let tokenClient = null;
let isSignedIn = false;
let currentUser = null;
let availableCourses = [];
let currentCourse = '';
let courseMap = {}; // Maps course codes to sheet names
let pendingNotifications = [];
let isInitializing = true;
let criticalErrorsOnly = true;

// Course data structure
const courseData = {
    metadata: {},
    modules: []
};

/**
 * Initialize the application.
 */
function init() {
    updateYear();
    
    // Show loading screen
    const loadingIndicator = document.getElementById('app-loading');
    loadingIndicator.style.display = 'flex';
    
    // Check for auth redirect
    checkAuthRedirect();
    
    // Initialize Google API
    setTimeout(() => {
        if (typeof gapi !== 'undefined' && typeof google !== 'undefined') {
            initGoogleApi();
        } else {
            console.warn('Google API objects not available yet, waiting longer...');
            setTimeout(() => {
                if (typeof gapi !== 'undefined' && typeof google !== 'undefined') {
                    console.log('Google API objects loaded after extended wait');
                    initGoogleApi();
                } else {
                    console.error('Google API objects still not available after extended wait');
                    showImprovedNotification('error', 'API Error', 'Google API libraries not loaded. Check your internet connection or try using a different browser.');
                    document.getElementById('course-content').innerHTML = '<div class="empty-content"><i class="fas fa-exclamation-triangle"></i><br>Failed to load course materials.<br>Please try refreshing the page.</div>';
                    showMainContent();
                }
            }, 3000);
        }
    }, 1000);
    
    // Show content after a timeout even if auth fails
    setTimeout(() => {
        showMainContent();
        isInitializing = false;
        criticalErrorsOnly = false;
        processPendingNotifications();
    }, 3000);
}

/**
 * Show the main content when ready
 */
function showMainContent() {
    const loadingIndicator = document.getElementById('app-loading');
    const mainContainer = document.getElementById('main-container');
    
    if (loadingIndicator) {
        loadingIndicator.style.opacity = '0';
        setTimeout(() => {
            loadingIndicator.style.display = 'none';
        }, 500);
    }
    
    if (mainContainer) {
        mainContainer.classList.remove('content-hidden');
    }
}

/**
 * Check for auth redirect and token in URL.
 */
function checkAuthRedirect() {
    // Handle auth redirect token at the very start
    if (window.location.hash && window.location.hash.includes('access_token=')) {
        console.log('Detected auth redirect with token');
        
        // Parse the hash parameters
        const params = {};
        window.location.hash.substring(1).split('&').forEach(pair => {
            const [key, value] = pair.split('=');
            params[key] = decodeURIComponent(value);
        });
        
        if (params.access_token) {
            console.log('Successfully extracted access token');
            
            // Set the token in gapi client (will happen after gapi is loaded)
            const processToken = () => {
                if (typeof gapi !== 'undefined' && gapi.client) {
                    gapi.client.setToken({ access_token: params.access_token });
                    localStorage.setItem('gapi_token', JSON.stringify({ access_token: params.access_token }));
                    isSignedIn = true;
                    
                    // Get course list and load first course
                    fetchUserInfo()
                        .then(() => {
                            fetchAvailableCourses()
                                .then(() => {
                                    if (availableCourses.length > 0) {
                                        selectCourse(availableCourses[0]);
                                    }
                                })
                                .catch(err => console.error('Error:', err));
                        })
                        .catch(err => console.error('Error fetching user info:', err));
                } else {
                    // If gapi isn't loaded yet, try again shortly
                    setTimeout(processToken, 100);
                }
            };
            
            // Start the token processing
            processToken();
            
            // Clean up the URL to remove the token (for security)
            if (history.replaceState) {
                history.replaceState(null, null, window.location.pathname);
            } else {
                window.location.hash = '';
            }
        }
    }
}

/**
 * Initialize the Google API client.
 */
function initGoogleApi() {
    console.log('Initializing Google API...');
    
    if (typeof gapi === 'undefined') {
        console.error('gapi object is undefined');
        showImprovedNotification('error', 'API Error', 'Google API client not loaded.');
        showMainContent();
        return;
    }
    
    if (typeof google === 'undefined' || typeof google.accounts === 'undefined') {
        console.error('google.accounts object is undefined');
        showImprovedNotification('error', 'API Error', 'Google Identity Services not loaded.');
        showMainContent();
        return;
    }
    
    // Set up token client for auth
    try {
        tokenClient = google.accounts.oauth2.initTokenClient({
            client_id: CLIENT_ID,
            scope: SCOPES,
            callback: handleTokenResponse
        });
    } catch (error) {
        console.error('Failed to initialize token client:', error);
        showImprovedNotification('error', 'Auth Error', 'Failed to initialize authentication.');
    }
    
    // Load the GAPI client
    gapi.load('client', () => {
        gapi.client.init({
            apiKey: API_KEY,
            discoveryDocs: DISCOVERY_DOCS
        }).then(() => {
            console.log('GAPI client initialized successfully');
            
            // Try to restore saved session
            const savedToken = localStorage.getItem('gapi_token');
            if (savedToken) {
                try {
                    const tokenObj = JSON.parse(savedToken);
                    gapi.client.setToken(tokenObj);
                    isSignedIn = true;
                    
                    // Update auth buttons
                    document.getElementById('sign-in-btn').style.display = 'none';
                    document.getElementById('sign-out-btn').style.display = 'inline-block';
                    
                    // Get user info
                    fetchUserInfo()
                        .then(() => {
                            // Fetch courses and select first one
                            fetchAvailableCourses()
                                .then(() => {
                                    if (availableCourses.length > 0) {
                                        selectCourse(availableCourses[0]);
                                    }
                                    showMainContent();
                                })
                                .catch(err => {
                                    console.error('Error fetching courses with saved token:', err);
                                    document.getElementById('course-content').innerHTML = '<div class="empty-content"><i class="fas fa-exclamation-triangle"></i><br>Failed to load courses.<br>Please try refreshing the page.</div>';
                                    showMainContent();
                                });
                        })
                        .catch(err => {
                            console.error('Error fetching user info:', err);
                            // Token might be expired or invalid
                            isSignedIn = false;
                            localStorage.removeItem('gapi_token');
                            document.getElementById('sign-in-btn').style.display = 'inline-block';
                            document.getElementById('sign-out-btn').style.display = 'none';
                            document.getElementById('signin-container').style.display = 'block';
                            showMainContent();
                        });
                } catch (e) {
                    console.error('Error restoring token:', e);
                    isSignedIn = false;
                    localStorage.removeItem('gapi_token');
                    document.getElementById('sign-in-btn').style.display = 'inline-block';
                    document.getElementById('sign-out-btn').style.display = 'none';
                    document.getElementById('signin-container').style.display = 'block';
                    showMainContent();
                }
            } else {
                // Not signed in, show sign-in prompt
                document.getElementById('sign-in-btn').style.display = 'inline-block';
                document.getElementById('sign-out-btn').style.display = 'none';
                document.getElementById('signin-container').style.display = 'block';
                showMainContent();
            }
        }).catch(error => {
            console.error('Error initializing GAPI client:', error);
            showImprovedNotification('error', 'API Error', 'Failed to initialize Google API.');
            showMainContent();
        });
    });
}

/**
 * Fetch user info (profile) from Google.
 */
async function fetchUserInfo() {
    try {
        const tokenObj = gapi.client.getToken();
        if (!tokenObj || !tokenObj.access_token) {
            console.error('No valid token available');
            throw new Error('No valid token available');
        }
        
        console.log('Fetching user info with token');
        
        const response = await fetch('https://www.googleapis.com/oauth2/v3/userinfo', {
            headers: { 'Authorization': `Bearer ${tokenObj.access_token}` }
        });
        
        if (!response.ok) {
            console.error('Failed to fetch user info, status:', response.status);
            throw new Error(`Failed to fetch user info: ${response.status} ${response.statusText}`);
        }
        
        const userInfo = await response.json();
        console.log('User info fetched successfully:', userInfo.email);
        
        currentUser = {
            id: userInfo.sub,
            name: userInfo.name || userInfo.email,
            email: userInfo.email,
            picture: userInfo.picture || 'https://via.placeholder.com/32'
        };
        
        // Update user info in UI
        document.getElementById('user-name').textContent = currentUser.name;
        document.getElementById('user-avatar').src = currentUser.picture;
        document.getElementById('user-info-container').style.display = 'flex';
        
        return currentUser;
    } catch (error) {
        console.error('Error fetching user info:', error);
        showImprovedNotification('error', 'User Info Error', error.message || 'Failed to get user information');
        throw error;
    }
}

/**
 * Handle token response from Google OAuth.
 */
function handleTokenResponse(resp) {
    console.log('Received token response');
    
    if (resp.error !== undefined) {
        console.error('Token response error:', resp.error);
        showImprovedNotification('error', 'Auth Error', `Authentication error: ${resp.error}`);
        return;
    }
    
    if (!resp.access_token) {
        console.error('No access token in response');
        showImprovedNotification('error', 'Auth Error', 'Did not receive access token');
        return;
    }
    
    try {
        // Store token in localStorage for session persistence
        localStorage.setItem('gapi_token', JSON.stringify(gapi.client.getToken()));
        
        // User is signed in
        isSignedIn = true;
        
        // Update auth buttons
        document.getElementById('sign-in-btn').style.display = 'none';
        document.getElementById('sign-out-btn').style.display = 'inline-block';
        document.getElementById('signin-container').style.display = 'none';
        
        // Get user info
        fetchUserInfo()
            .then(() => {
                // Fetch available courses and select the first one
                fetchAvailableCourses()
                    .then(() => {
                        if (availableCourses.length > 0) {
                            selectCourse(availableCourses[0]);
                        }
                    })
                    .catch(err => console.error('Error:', err));
            })
            .catch(err => console.error('Error fetching user info:', err));
        
        showImprovedNotification('success', 'Signed In', 'Successfully signed in');
    } catch (error) {
        console.error('Error processing token:', error);
        showImprovedNotification('error', 'Auth Error', 'Error during sign-in process');
    }
}

/**
 * Handle auth button click to sign in.
 */
function handleAuthClick() {
    console.log('Auth button clicked - redirecting to Google auth');
    
    // Show notification that we're redirecting
    showImprovedNotification('info', 'Signing In', 'Redirecting to Google...');
    
    // Get the exact current URL as redirect URI
    const redirectUri = window.location.origin + window.location.pathname;
    console.log('Using redirect URI:', redirectUri);
    
    // Create Google OAuth URL with scopes
    const scopes = encodeURIComponent(SCOPES);
    const authUrl = `https://accounts.google.com/o/oauth2/v2/auth?` +
                   `client_id=${CLIENT_ID}&` +
                   `redirect_uri=${encodeURIComponent(redirectUri)}&` +
                   `response_type=token&` +
                   `scope=${scopes}`;
    
    console.log('Auth URL:', authUrl);
    
    // Add a small delay before redirecting
    setTimeout(() => {
        window.location.href = authUrl;
    }, 100);
}

/**
 * Handle sign out button click
 */
function handleSignoutClick() {
    try {
        const token = gapi.client.getToken();
        if (token !== null) {
            console.log('Revoking token and signing out');
            google.accounts.oauth2.revoke(token.access_token, () => {
                gapi.client.setToken('');
                localStorage.removeItem('gapi_token');
                isSignedIn = false;
                currentUser = null;
                
                // Update UI elements
                document.getElementById('sign-in-btn').style.display = 'inline-block';
                document.getElementById('sign-out-btn').style.display = 'none';
                document.getElementById('user-info-container').style.display = 'none';
                document.getElementById('signin-container').style.display = 'block';
                
                // Clear course content
                document.getElementById('course-content').innerHTML = '';
                document.getElementById('course-buttons-container').innerHTML = '';
                
                // Reset course header
                document.getElementById('course-code').textContent = 'Course Code';
                document.getElementById('course-title').textContent = 'Please sign in to view courses';
                
                showImprovedNotification('info', 'Signed Out', 'You have been successfully signed out');
            });
        }
    } catch (error) {
        console.error('Error during sign out:', error);
        
        // Force sign-out even if there's an error
        localStorage.removeItem('gapi_token');
        isSignedIn = false;
        currentUser = null;
        
        document.getElementById('sign-in-btn').style.display = 'inline-block';
        document.getElementById('sign-out-btn').style.display = 'none';
        document.getElementById('user-info-container').style.display = 'none';
        document.getElementById('signin-container').style.display = 'block';
        
        document.getElementById('course-content').innerHTML = '';
        document.getElementById('course-buttons-container').innerHTML = '';
    }
}

/**
 * Fetch available courses (sheet names) from spreadsheet.
 */
async function fetchAvailableCourses() {
    if (!isSignedIn) {
        console.log('User not signed in, cannot fetch courses');
        return [];
    }
    
    try {
        console.log('Fetching available courses from spreadsheet...');
        
        // Use authenticated client
        const response = await gapi.client.sheets.spreadsheets.get({
            spreadsheetId: COURSE_MATERIALS_SPREADSHEET_ID
        });
        
        const sheets = response.result.sheets || [];
        availableCourses = sheets.map(sheet => sheet.properties.title);
        
        console.log('Fetched courses:', availableCourses);
        
        // Populate course selector
        populateCourseButtons();
        
        return availableCourses;
    } catch (error) {
        console.error('Error fetching courses:', error);
        showImprovedNotification('error', 'Courses Error', 'Failed to fetch available courses');
        throw error;
    }
}

/**
 * Populate course buttons for course selection.
 */
function populateCourseButtons() {
    // Get button container
    const courseButtonsContainer = document.getElementById('course-buttons-container');
    if (!courseButtonsContainer) return;
    
    // Clear existing buttons
    courseButtonsContainer.innerHTML = '';
    
    // Fetch course codes for each sheet
    fetchCourseCodes()
        .then(() => {
            // Add buttons for all available courses
            availableCourses.forEach(sheetName => {
                const courseCode = courseMap[sheetName] || sheetName;
                
                const button = document.createElement('div');
                button.className = 'course-button' + (currentCourse === sheetName ? ' active' : '');
                button.innerHTML = `<i class="fas fa-th-list"></i>&nbsp; ${courseCode}`;
                button.setAttribute('data-sheet', sheetName);
                button.addEventListener('click', () => {
                    selectCourse(sheetName);
                });
                courseButtonsContainer.appendChild(button);
            });
        })
        .catch(err => {
            console.error('Error fetching course codes:', err);
            
            // Fallback to sheet names if course codes are unavailable
            availableCourses.forEach(sheetName => {
                const button = document.createElement('div');
                button.className = 'course-button' + (currentCourse === sheetName ? ' active' : '');
                button.innerHTML = `<i class="fas fa-th-list"></i>&nbsp; ${sheetName}`;
                button.setAttribute('data-sheet', sheetName);
                button.addEventListener('click', () => {
                    selectCourse(sheetName);
                });
                courseButtonsContainer.appendChild(button);
            });
        });
}

/**
 * Fetch course codes from each sheet's metadata.
 */
async function fetchCourseCodes() {
    if (!isSignedIn) {
        console.log('User not signed in, cannot fetch course codes');
        return {};
    }
    
    try {
        const promises = availableCourses.map(async (sheetName) => {
            try {
                // Use authenticated client
                const response = await gapi.client.sheets.spreadsheets.values.get({
                    spreadsheetId: COURSE_MATERIALS_SPREADSHEET_ID,
                    range: `${sheetName}!A2:C10` // Get metadata rows
                });
                const rows = response.result.values || [];
                
                // Look for "metadata" type rows with key "code"
                for (const row of rows) {
                    if (row[0]?.toLowerCase() === 'metadata' && row[1]?.toLowerCase() === 'code') {
                        courseMap[sheetName] = row[2] || sheetName;
                        break;
                    }
                }
            } catch (error) {
                console.error(`Error fetching metadata for ${sheetName}:`, error);
                // Use sheetName as fallback
                courseMap[sheetName] = sheetName;
            }
        });
        
        await Promise.all(promises);
        return courseMap;
    } catch (error) {
        console.error('Error fetching course codes:', error);
        throw error;
    }
}

/**
 * Select a course and load its materials.
 */
function selectCourse(sheetName) {
    // Require authentication
    if (!isSignedIn) {
        document.getElementById('signin-container').style.display = 'block';
        document.getElementById('course-content').innerHTML = '';
        return;
    }
    
    currentCourse = sheetName;
    
    // Update active button visually
    document.querySelectorAll('.course-button').forEach(btn => {
        btn.classList.remove('active');
        if (btn.getAttribute('data-sheet') === sheetName) {
            btn.classList.add('active');
        }
    });
    
    // Show loading state
    document.getElementById('course-content').innerHTML = `
        <div class="loading-spinner"></div>
        <div class="loading-text">Loading materials...</div>
    `;
    
    // Load course data
    fetchCourseData(sheetName)
        .then(data => {
            if (data) {
                // Update document title with course code
                document.title = data.metadata.code ? `${data.metadata.code} | Course Materials` : 'Course Materials';
                
                // Update course metadata
                updateCourseMetadata(data.metadata);
                
                // Generate course content HTML
                const contentHtml = generateCourseContentHtml(data.modules);
                document.getElementById('course-content').innerHTML = contentHtml;
                
                // Attach event listeners to module headers
                document.querySelectorAll('.module-header').forEach(header => {
                    header.addEventListener('click', () => toggleModule(header.parentNode));
                });
                
                showImprovedNotification('success', 'Course Loaded', `${data.metadata.code || sheetName} materials loaded successfully`);
            } else {
                document.getElementById('course-content').innerHTML = `
                    <div class="empty-content">
                        <i class="fas fa-exclamation-triangle"></i><br>
                        No materials found for this course.<br>
                        Please select another course.
                    </div>
                `;
            }
        })
        .catch(error => {
            console.error(`Error loading ${sheetName} materials:`, error);
            document.getElementById('course-content').innerHTML = `
                <div class="empty-content">
                    <i class="fas fa-exclamation-triangle"></i><br>
                    Error loading course materials.<br>
                    Please try again later.
                </div>
            `;
            showImprovedNotification('error', 'Load Error', `Failed to load course materials`);
        });
}

/**
 * Fetch course data from spreadsheet.
 */
async function fetchCourseData(sheetName) {
    if (!isSignedIn) {
        console.log('User not signed in, cannot fetch course data');
        return null;
    }
    
    try {
        // Use authenticated client
        const response = await gapi.client.sheets.spreadsheets.values.get({
            spreadsheetId: COURSE_MATERIALS_SPREADSHEET_ID,
            range: `${sheetName}!A2:J`
        });
        
        const rows = response.result.values || [];
        
        if (rows.length === 0) {
            return null;
        }
        
        return processCourseData(rows);
    } catch (error) {
        console.error('Error fetching course data:', error);
        showImprovedNotification('error', 'Data Error', 'Failed to fetch course data');
        throw error;
    }
}

/**
 * Process the raw spreadsheet data into a structured format.
 */
function processCourseData(rows) {
    const data = {
        metadata: {},
        modules: []
    };
    
    let currentModule = null;
    
    rows.forEach(row => {
        if (!row || row.length === 0) return;
        
        const type = row[0]?.toLowerCase();
        
        if (type === 'metadata') {
            // Process metadata row
            const key = row[1]?.toLowerCase();
            const value = row[2] || '';
            
            if (key) {
                data.metadata[key] = value;
            }
        } else if (type === 'module') {
            // Start a new module
            currentModule = {
                id: row[1] || Date.now().toString(),
                title: row[2] || 'Untitled Module',
                icon: row[3] || 'fas fa-folder',
                moduleNumber: row[4] || '',
                isActive: (row[5]?.toLowerCase() === 'true'),
                materials: [],
                funFacts: []
            };
            data.modules.push(currentModule);
        } else if (type === 'material' && currentModule) {
            // Add material to current module
            currentModule.materials.push({
                icon: row[1] || 'far fa-file',
                title: row[2] || 'Untitled Material',
                description: row[3] || '',
                viewLink: row[4] || '',
                downloadLink: row[5] || ''
            });
        } else if (type === 'funfact' && currentModule) {
            // Add fun fact to current module
            currentModule.funFacts.push({
                text: row[1] || ''
            });
        }
    });
    
    return data;
}

/**
 * Update the course metadata in the UI.
 */
function updateCourseMetadata(metadata) {
    document.getElementById('course-code').textContent = metadata.code || 'Course Code';
    document.getElementById('course-title').textContent = metadata.title || 'Course Title';
    document.getElementById('course-semester').textContent = metadata.semester || 'Unknown Semester';
    document.getElementById('course-level').textContent = metadata.level || 'Undergraduate';
    document.getElementById('course-type').textContent = metadata.type || 'Compulsory';
    document.getElementById('course-credits').textContent = metadata.credits || '5 ECTS';
    document.getElementById('course-duration').textContent = metadata.duration || '16 weeks';
    
    // Update week counter and progress bar if dates provided
    if (metadata.startdate && metadata.enddate) {
        updateWeekProgress(metadata.startdate, metadata.enddate, metadata.holidayweeks);
    } else {
        // Default values if not provided
        updateWeekProgress();
    }
}

/**
 * Generate the HTML for course modules and materials.
 */
function generateCourseContentHtml(modules) {
    if (!modules || modules.length === 0) {
        return '<div class="empty-content"><i class="fas fa-folder-open"></i><br>No content available for this course.</div>';
    }
    
    let html = '';
    
    modules.forEach(module => {
        html += `
        <div class="module${module.isActive ? ' active' : ''}">
            <div class="module-header">
                <span class="module-title"><i class="${module.icon}"></i>&nbsp;&nbsp;${module.title}</span>
                <span class="module-chapter">${module.moduleNumber ? 'Module ' + module.moduleNumber : ''}&nbsp;&nbsp;<i class="fas fa-chevron-down"></i></span>
            </div>
            <div class="module-content">
        `;
        
        // Add materials
        module.materials.forEach(material => {
            html += `
                <div class="material-item">
                    <i class="${material.icon} material-icon"></i>
                    <div class="material-info">
                        <div class="material-title">${material.title}</div>
                        <div class="material-description">${material.description}</div>
                    </div>
                    <div class="course-actions">
            `;
            
            // Only add View button if link is provided and not empty
            if (material.viewLink && material.viewLink !== '#' && material.viewLink !== '') {
                html += `<button onclick="window.open('${material.viewLink}', '_blank', 'noopener,noreferrer')" class="btn-blue"><i class="far fa-eye"></i> View</button>`;
            }
            
            // Only add Download button if link is provided
            if (material.downloadLink && material.downloadLink !== '#' && material.downloadLink !== '') {
                html += `<button onclick="window.open('${material.downloadLink}', '_blank', 'noopener,noreferrer')" class="btn-download btn-green"><i class="far fa-save"></i> Download</button>`;
            }
            
            html += `
                    </div>
                </div>
            `;
        });
        
        // Add fun facts
        module.funFacts.forEach(funFact => {
            html += `<div class="fun-fact">${funFact.text}</div>`;
        });
        
        html += `
            </div>
        </div>
        `;
    });
    
    return html;
}

/**
 * Toggle module expansion.
 */
function toggleModule(element) {
    element.classList.toggle('active');
}

/**
 * Calculate the current week of the course.
 */
function calculateWeek(startDate, endDate, holidayWeeks = 0) {
    const start = new Date(startDate);
    const end = new Date(endDate);
    const today = new Date();
    const totalWeeks = Math.ceil((end - start) / (7 * 24 * 60 * 60 * 1000));
    const currentWeek = Math.ceil((today - start) / (7 * 24 * 60 * 60 * 1000));
    const adjustedWeek = currentWeek - parseInt(holidayWeeks || 0);
    return Math.min(Math.max(adjustedWeek, 1), totalWeeks);
}

/**
 * Update the week counter and progress bar.
 */
function updateWeekProgress(startDate = "2025-02-24", endDate = "2025-06-14", holidayWeeks = 0) {
    const weekCounter = document.getElementById('week-counter');
    const currentWeek = calculateWeek(startDate, endDate, holidayWeeks);
    weekCounter.textContent = `Week ${currentWeek}`;
    
    // Update progress bar
    const start = new Date(startDate);
    const end = new Date(endDate);
    const today = new Date();
    const totalDuration = end - start;
    const elapsedDuration = today - start;
    let progressPercentage = (elapsedDuration / totalDuration) * 100;
    progressPercentage = Math.min(Math.max(progressPercentage, 0), 100);

    const progress = document.getElementById('progress-bar');
    progress.style.width = progressPercentage + '%';
}

/**
 * Update current year in footer.
 */
function updateYear() {
    const yearElement = document.getElementById('currentYear');
    if (yearElement) {
        yearElement.textContent = new Date().getFullYear();
    }
}

/**
 * Show notification to the user.
 */
function showImprovedNotification(type, title, message, duration) {
    // Skip redundant notifications during initialization
    if (isInitializing || criticalErrorsOnly) {
        const isCritical = type === 'error' && 
                          (title.includes('Critical') || 
                           message.includes('Permission denied'));
        
        if (!isCritical) {
            // Store non-critical notifications for later
            pendingNotifications.push({type, title, message, duration});
            return;
        }
    }

    // Safely remove notifications
    const safeRemove = (element) => {
        try {
            if (element && element.parentNode) {
                element.parentNode.removeChild(element);
            }
        } catch (e) {
            console.log('Error removing notification:', e);
        }
    };

    const notificationArea = document.getElementById('notification-area');
    if (!notificationArea) return;

    // Clear existing notifications of the same type
    const existingNotifications = notificationArea.querySelectorAll(`.in-page-notification-${type}`);
    existingNotifications.forEach(notification => {
        notification.classList.add('removing');
        setTimeout(() => safeRemove(notification), 300);
    });

    // Limit total notifications to 2
    const allNotifications = notificationArea.querySelectorAll('.in-page-notification');
    if (allNotifications.length >= 2) {
        const oldest = allNotifications[0];
        oldest.classList.add('removing');
        setTimeout(() => safeRemove(oldest), 300);
    }

    // Create the new notification
    const notification = document.createElement('div');
    notification.className = `in-page-notification in-page-notification-${type}`;

    let icon;
    switch(type) {
        case 'success': icon = 'check-circle'; break;
        case 'error': icon = 'times-circle'; break;
        case 'warning': icon = 'exclamation-circle'; break;
        default: icon = 'info-circle';
    }

    notification.innerHTML = `
        <i class="fas fa-${icon}"></i>
        <div style="flex-grow:1;">
            <strong>${title}</strong><br>
            ${message}
        </div>
        <button class="notification-close">&times;</button>
    `;

    notificationArea.appendChild(notification);

    // Add click handler to close button
    const closeBtn = notification.querySelector('.notification-close');
    if (closeBtn) {
        closeBtn.addEventListener('click', function(e) {
            e.preventDefault();
            e.stopPropagation();
            notification.classList.add('removing');
            setTimeout(() => safeRemove(notification), 300);
        });
    }

    // Auto-remove non-error notifications
    if (type !== 'error') {
        setTimeout(() => {
            notification.classList.add('removing');
            setTimeout(() => safeRemove(notification), 300);
        }, duration || 5000);
    }
}

/**
 * Process any pending notifications.
 */
function processPendingNotifications() {
    if (pendingNotifications.length > 0) {
        // Only show the most recent notification of each type
        const uniqueNotifications = {};
        for (const notification of pendingNotifications) {
            uniqueNotifications[notification.type + notification.title] = notification;
        }
        
        // Display only the unique notifications
        Object.values(uniqueNotifications).forEach(notification => {
            showImprovedNotification(
                notification.type, 
                notification.title, 
                notification.message, 
                notification.duration
            );
        });
        
        pendingNotifications = [];
    }
}

// Initialize the application when window loads
window.addEventListener('load', init);
</script>
</body>
</html>